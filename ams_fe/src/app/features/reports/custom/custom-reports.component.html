<div class="space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Custom Report Builder</h1>
      <p class="text-gray-600 mt-1">Create, save, and run custom reports with flexible filters</p>
    </div>
    <div *ngIf="activeTab === 'builder' && selectedFields.length > 0" class="flex items-center gap-3">
      <button
        type="button"
        (click)="runReport()"
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2"
      >
        <lucide-icon name="play" class="w-4 h-4"></lucide-icon>
        Run Report
      </button>
      <button
        type="button"
        (click)="saveReport()"
        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
      >
        <lucide-icon name="save" class="w-4 h-4"></lucide-icon>
        Save Report
      </button>
    </div>
  </div>

  <div class="flex gap-2 border-b border-gray-200">
    <button
      type="button"
      (click)="setActiveTab('builder')"
      [ngClass]="activeTab === 'builder'
        ? 'flex items-center gap-2 px-4 py-3 border-b-2 transition-colors border-blue-600 text-blue-600'
        : 'flex items-center gap-2 px-4 py-3 border-b-2 transition-colors border-transparent text-gray-600 hover:text-gray-900'"
    >
      <lucide-icon name="bar-chart-3" class="w-4 h-4"></lucide-icon>
      Report Builder
    </button>
    <button
      type="button"
      (click)="setActiveTab('saved')"
      [ngClass]="activeTab === 'saved'
        ? 'flex items-center gap-2 px-4 py-3 border-b-2 transition-colors border-blue-600 text-blue-600'
        : 'flex items-center gap-2 px-4 py-3 border-b-2 transition-colors border-transparent text-gray-600 hover:text-gray-900'"
    >
      <lucide-icon name="save" class="w-4 h-4"></lucide-icon>
      Saved Reports
    </button>
  </div>

  <div *ngIf="activeTab === 'builder'" class="grid grid-cols-3 gap-6">
    <div class="col-span-1 space-y-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="font-semibold text-gray-900 mb-4">Report Information</h3>
        <form [formGroup]="reportForm" class="space-y-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Report Name</label>
            <input
              type="text"
              formControlName="name"
              placeholder="e.g., Monthly Attendance Report"
              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea
              formControlName="description"
              rows="2"
              placeholder="Brief description..."
              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm"
            ></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select
              formControlName="category"
              class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm"
            >
              <option *ngFor="let cat of fieldCategories" [value]="cat">
                {{ cat.charAt(0).toUpperCase() + cat.slice(1) }}
              </option>
            </select>
          </div>
        </form>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="font-semibold text-gray-900 mb-4">Select Fields</h3>
        <div class="space-y-4">
          <div *ngFor="let category of fieldCategories">
            <h4 class="text-sm font-medium text-gray-700 mb-2 capitalize">{{ category }}</h4>
            <div class="space-y-2">
              <label
                *ngFor="let field of fieldsByCategory[category]"
                class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-2 rounded"
              >
                <input
                  type="checkbox"
                  [checked]="selectedFields.includes(field.id)"
                  (change)="toggleField(field.id)"
                  class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300"
                />
                <span class="text-sm text-gray-700">{{ field.name }}</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-span-2 space-y-6">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-gray-900">Selected Fields ({{ selectedFields.length }})</h3>
          <button
            *ngIf="selectedFields.length > 0"
            type="button"
            (click)="clearSelectedFields()"
            class="text-sm text-red-600 hover:text-red-700"
          >
            Clear All
          </button>
        </div>
        <div *ngIf="selectedFields.length > 0; else emptySelectedFields" class="flex flex-wrap gap-2">
          <div
            *ngFor="let fieldId of selectedFields"
            class="flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg"
          >
            <span class="text-sm">{{ fieldNameById[fieldId] || fieldId }}</span>
            <button type="button" (click)="toggleField(fieldId)" class="hover:bg-blue-200 rounded p-0.5">
              <lucide-icon name="x" class="w-3 h-3"></lucide-icon>
            </button>
          </div>
        </div>
        <ng-template #emptySelectedFields>
          <p class="text-sm text-gray-500">No fields selected. Select fields from the left panel.</p>
        </ng-template>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6" [formGroup]="reportForm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-semibold text-gray-900">Filters</h3>
          <button
            type="button"
            (click)="addFilter()"
            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 text-sm"
          >
            <lucide-icon name="plus" class="w-4 h-4"></lucide-icon>
            Add Filter
          </button>
        </div>
        <div *ngIf="filters.length > 0; else emptyFilters" formArrayName="filters" class="space-y-3">
          <div
            *ngFor="let filterGroup of filters.controls; index as i"
            [formGroupName]="i"
            class="flex items-center gap-3 bg-gray-50 p-3 rounded-lg"
          >
            <span class="text-sm text-gray-600 font-medium w-12">
              {{ i === 0 ? 'WHERE' : 'AND' }}
            </span>
            <select
              formControlName="field"
              class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
            >
              <option value="">Select field...</option>
              <option *ngFor="let field of availableFields" [value]="field.id">
                {{ field.name }}
              </option>
            </select>
            <select
              formControlName="operator"
              class="w-32 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
            >
              <option *ngFor="let op of operators" [value]="op.value">
                {{ op.label }}
              </option>
            </select>
            <input
              type="text"
              formControlName="value"
              placeholder="Value..."
              class="flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-300"
            />
            <button type="button" (click)="removeFilter(i)" class="p-2 hover:bg-red-50 rounded">
              <lucide-icon name="trash-2" class="w-4 h-4 text-red-600"></lucide-icon>
            </button>
          </div>
        </div>
        <ng-template #emptyFilters>
          <p class="text-sm text-gray-500">No filters applied. Add filters to refine your report.</p>
        </ng-template>
      </div>

      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h3 class="font-semibold text-gray-900 mb-4">Visualization</h3>
        <div class="grid grid-cols-4 gap-3">
          <button
            type="button"
            (click)="setChartType('table')"
            [ngClass]="chartType === 'table'
              ? 'flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors border-blue-600 bg-blue-50'
              : 'flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors border-gray-200 hover:border-gray-300'"
          >
            <lucide-icon [ngClass]="chartType === 'table' ? 'w-6 h-6 text-blue-600' : 'w-6 h-6 text-gray-600'" name="table"></lucide-icon>
            <span [ngClass]="chartType === 'table' ? 'text-sm font-medium text-blue-600' : 'text-sm font-medium text-gray-600'">Table</span>
          </button>
          <button
            type="button"
            (click)="setChartType('bar')"
            [ngClass]="chartType === 'bar'
              ? 'flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors border-blue-600 bg-blue-50'
              : 'flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors border-gray-200 hover:border-gray-300'"
          >
            <lucide-icon [ngClass]="chartType === 'bar' ? 'w-6 h-6 text-blue-600' : 'w-6 h-6 text-gray-600'" name="bar-chart-3"></lucide-icon>
            <span [ngClass]="chartType === 'bar' ? 'text-sm font-medium text-blue-600' : 'text-sm font-medium text-gray-600'">Bar Chart</span>
          </button>
          <button
            type="button"
            (click)="setChartType('pie')"
            [ngClass]="chartType === 'pie'
              ? 'flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors border-blue-600 bg-blue-50'
              : 'flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors border-gray-200 hover:border-gray-300'"
          >
            <lucide-icon [ngClass]="chartType === 'pie' ? 'w-6 h-6 text-blue-600' : 'w-6 h-6 text-gray-600'" name="pie-chart"></lucide-icon>
            <span [ngClass]="chartType === 'pie' ? 'text-sm font-medium text-blue-600' : 'text-sm font-medium text-gray-600'">Pie Chart</span>
          </button>
          <button
            type="button"
            (click)="setChartType('line')"
            [ngClass]="chartType === 'line'
              ? 'flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors border-blue-600 bg-blue-50'
              : 'flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors border-gray-200 hover:border-gray-300'"
          >
            <lucide-icon [ngClass]="chartType === 'line' ? 'w-6 h-6 text-blue-600' : 'w-6 h-6 text-gray-600'" name="trending-up"></lucide-icon>
            <span [ngClass]="chartType === 'line' ? 'text-sm font-medium text-blue-600' : 'text-sm font-medium text-gray-600'">Line Chart</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="activeTab === 'saved'" class="space-y-6">
    <div class="grid grid-cols-4 gap-4">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Total Reports</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">{{ savedReports.length }}</p>
          </div>
          <lucide-icon name="save" class="w-8 h-8 text-blue-600"></lucide-icon>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Run This Month</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">24</p>
          </div>
          <lucide-icon name="play" class="w-8 h-8 text-green-600"></lucide-icon>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Categories</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">4</p>
          </div>
          <lucide-icon name="filter" class="w-8 h-8 text-purple-600"></lucide-icon>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-600">Scheduled</p>
            <p class="text-2xl font-bold text-gray-900 mt-1">2</p>
          </div>
          <lucide-icon name="calendar" class="w-8 h-8 text-orange-600"></lucide-icon>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div
        *ngFor="let report of savedReports"
        class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow"
      >
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <lucide-icon [name]="getCategoryIcon(report.category)" class="w-5 h-5 text-blue-600"></lucide-icon>
            </div>
            <div>
              <h3 class="font-semibold text-gray-900">{{ report.name }}</h3>
              <p class="text-sm text-gray-600 mt-1">{{ report.description }}</p>
            </div>
          </div>
          <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
            {{ report.category }}
          </span>
        </div>

        <div class="space-y-2 mb-4">
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <lucide-icon name="check-square" class="w-4 h-4"></lucide-icon>
            {{ report.fields.length }} fields
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <lucide-icon name="filter" class="w-4 h-4"></lucide-icon>
            {{ report.filters.length }} filters
          </div>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <lucide-icon name="calendar" class="w-4 h-4"></lucide-icon>
            Last run: {{ report.lastRun }}
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center gap-2 text-sm" type="button">
            <lucide-icon name="play" class="w-4 h-4"></lucide-icon>
            Run
          </button>
          <button class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" type="button">
            <lucide-icon name="edit-2" class="w-4 h-4 text-gray-600"></lucide-icon>
          </button>
          <button class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors" type="button">
            <lucide-icon name="download" class="w-4 h-4 text-gray-600"></lucide-icon>
          </button>
          <button class="px-3 py-2 border border-red-200 rounded-lg hover:bg-red-50 transition-colors" type="button">
            <lucide-icon name="trash-2" class="w-4 h-4 text-red-600"></lucide-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showPreview" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold text-gray-900">Report Preview</h2>
          <p class="text-gray-600 mt-1">{{ reportForm.value.name || 'Custom Report' }}</p>
        </div>
        <div class="flex items-center gap-3">
          <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2" type="button">
            <lucide-icon name="download" class="w-4 h-4"></lucide-icon>
            Export
          </button>
          <button type="button" (click)="closePreview()" class="p-2 hover:bg-gray-100 rounded-lg">
            <lucide-icon name="x" class="w-5 h-5 text-gray-600"></lucide-icon>
          </button>
        </div>
      </div>

      <div class="p-6">
        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th
                    *ngFor="let fieldId of selectedFields"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    {{ fieldNameById[fieldId] || fieldId }}
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                <tr *ngFor="let row of previewRows" class="hover:bg-gray-50">
                  <td *ngFor="let fieldId of selectedFields" class="px-6 py-4 text-sm text-gray-900">
                    {{ row[fieldId] }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="mt-4 text-sm text-gray-600">
          Showing 5 of 125 results. Applied {{ filters.length }} filter(s).
        </div>
      </div>
    </div>
  </div>
</div>
